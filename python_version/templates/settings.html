{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <h1 class="mb-4">{{ title }}</h1>
        <p class="text-muted">{% trans "Configure your preferences for voice communication here." %}</p>

        <div class="card bg-secondary text-light mb-4">
            <div class="card-header border-bottom border-dark">
                {% trans "Device Preferences" %}
            </div>
            <div class="card-body">

                <div class="mb-3">
                    <label for="audioInputSelect" class="form-label">{% trans "Microphone Selection (Input)" %}</label>
                    <select id="audioInputSelect" class="form-select bg-dark text-light border-dark"></select>
                </div>

                <div class="mb-3">
                    <label for="audioOutputSelect" class="form-label">{% trans "Speaker Selection (Output)" %}</label>
                    <select id="audioOutputSelect" class="form-select bg-dark text-light border-dark"></select>
                </div>

                <hr class="border-secondary">
                <div class="mb-3">
                    <label for="masterVolumeSelect" class="form-label">{% trans "Master Volume Level" %}</label>
                    <input type="range" class="form-range" id="masterVolumeSelect" min="0" max="1" step="0.01" value="1">
                </div>

                <div class="mb-3">
                    <label class="form-label">{% trans "Microphone Test (Input Level)" %}</label>
                    <progress id="micTestMeter" class="w-100" max="100" value="0"></progress>
                </div>

                <button id="save-settings-btn" class="btn btn-success mt-3">{% trans "Save Preferences" %}</button>
                <div id="save-status" class="mt-2 text-success" style="display: none;">{% trans "Your settings have been saved!" %}</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const audioInputSelect = document.getElementById('audioInputSelect');
    const audioOutputSelect = document.getElementById('audioOutputSelect');
    const masterVolumeSelect = document.getElementById('masterVolumeSelect');
    const micTestMeter = document.getElementById('micTestMeter');
    const saveButton = document.getElementById('save-settings-btn');
    const saveStatus = document.getElementById('save-status');

    let localTestStream = null;
    let audioContext = null;
    let analyserNode = null;
    let volumeMeterLoop = null;

    function loadSavedSettings() {
        const savedInput = localStorage.getItem('preferredAudioInput');
        const savedOutput = localStorage.getItem('preferredAudioOutput');
        const savedMasterVolume = localStorage.getItem('masterVolume');

        if (savedInput) audioInputSelect.value = savedInput;
        if (savedOutput) audioOutputSelect.value = savedOutput;
        if (savedMasterVolume) masterVolumeSelect.value = savedMasterVolume;
    }

    async function getDevices() {
        try {
            if (localTestStream) {
                localTestStream.getTracks().forEach(track => track.stop());
            }
            if (volumeMeterLoop) {
                cancelAnimationFrame(volumeMeterLoop);
            }

            const selectedInputId = audioInputSelect.value || localStorage.getItem('preferredAudioInput');

            localTestStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    deviceId: selectedInputId ? { exact: selectedInputId } : undefined
                },
                video: false
            });

            startMicTest(localTestStream);

        } catch (e) {
            console.error("Microphone permission denied:", e);
            alert("{% trans 'Please allow microphone access.' %}");
            return;
        }

        const devices = await navigator.mediaDevices.enumerateDevices();

        audioInputSelect.innerHTML = '';
        audioOutputSelect.innerHTML = '';

        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;

            if (device.kind === 'audioinput') {
                option.text = device.label || `{% trans 'Microphone' %} ${audioInputSelect.length + 1}`;
                audioInputSelect.appendChild(option);
            } else if (device.kind === 'audiooutput') {
                option.text = device.label || `{% trans 'Speaker' %} ${audioOutputSelect.length + 1}`;
                audioOutputSelect.appendChild(option);
            }
        });

        loadSavedSettings();
    }

    function startMicTest(stream) {
        if (!audioContext) {
            audioContext = new AudioContext();
        }
        analyserNode = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyserNode);

        analyserNode.fftSize = 256;
        const bufferLength = analyserNode.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function draw() {
            volumeMeterLoop = requestAnimationFrame(draw);
            analyserNode.getByteFrequencyData(dataArray);

            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            let avg = sum / bufferLength;

            micTestMeter.value = (avg / 1.28);
        }
        draw();
    }

    saveButton.addEventListener('click', () => {
        const selectedInput = audioInputSelect.value;
        const selectedOutput = audioOutputSelect.value;
        const selectedMasterVolume = masterVolumeSelect.value;

        if (selectedInput) localStorage.setItem('preferredAudioInput', selectedInput);
        if (selectedOutput) localStorage.setItem('preferredAudioOutput', selectedOutput);
        if (selectedMasterVolume) localStorage.setItem('masterVolume', selectedMasterVolume);

        saveStatus.style.display = 'block';
        setTimeout(() => { saveStatus.style.display = 'none'; }, 3000);
    });

    audioInputSelect.addEventListener('change', getDevices);

    getDevices();

    window.addEventListener('beforeunload', () => {
        if (localTestStream) {
            localTestStream.getTracks().forEach(track => track.stop());
        }
        if (volumeMeterLoop) {
            cancelAnimationFrame(volumeMeterLoop);
        }
        if (audioContext) {
            audioContext.close();
        }
    });
</script>
{% endblock %}
